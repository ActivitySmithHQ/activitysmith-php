name: Sync Packagist

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    environment: release
    env:
      PACKAGIST_USERNAME: ${{ secrets.PACKAGIST_USERNAME }}
      PACKAGIST_TOKEN: ${{ secrets.PACKAGIST_TOKEN }}
    steps:
      - name: Require Packagist credentials
        run: |
          if [ -z "$PACKAGIST_USERNAME" ] || [ -z "$PACKAGIST_TOKEN" ]; then
            echo "Missing PACKAGIST_USERNAME or PACKAGIST_TOKEN secrets."
            exit 1
          fi

      - name: Trigger Packagist update
        run: |
          curl --fail --show-error --silent \
            -X POST "https://packagist.org/api/update-package?username=${PACKAGIST_USERNAME}&apiToken=${PACKAGIST_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"repository":{"url":"https://github.com/ActivitySmithHQ/activitysmith-php"}}'
